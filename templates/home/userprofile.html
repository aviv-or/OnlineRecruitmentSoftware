{% extends 'base.html' %}

{% block title %}{{user.name}} | Profile{% endblock %}

{% block headcss %}
{% load static %}
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="{% static 'home/profile.css' %}">
{% endblock %}

{% block content %}

<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <img id="logo" src="{% static 'image/logo.svg' %}" onerror="this.src='{% static 'image/logo.svg' %}'">
            <a class="navbar-brand" href="#">
                Hiresome
            </a>
        </div>
        <ul class="nav navbar-nav">
            
        </ul>
        <ul class="nav navbar-nav navbar-right">
            {% if user.role == "PS" or user.role == "SU" %}
             <li class="dropdown">
                <a class="dropdown-toggle" id="nav-action-box" data-toggle="dropdown" href="#">
                    <span class="fa fa-plus" id="plus-btn"></span>
                </a>
                <ul class="dropdown-menu">
                    {% if user.role == "PS" %}
                    <li><a href="/create/problem-set">Create Problem Set</a></li>
                    {% elif user.role == "SU" %}
                    <li><a href="/create/test-module">Create Test Module</a></li>
                    {% endif %}
                </ul>
            </li>
            {% endif %}
            <li class="dropdown">
                <a class="dropdown-toggle" id="account-btn-box" data-toggle="dropdown" href="#">
                    <span id="account-btn">{{user.initial}}</span>
                </a>
                <ul class="dropdown-menu">
                    <li><a href="/profile"> Profile </a></li>
                    <li><a href="/logout?r=/"> Logout </a></li>
                </ul>
            </li>
        </ul>
    </div>
</nav>
<div id="main-wrapper">
<div class="col-xs-12 col-lg-4">
    <div class="col-xs-12 col-lg-10 col-lg-push-1" id="profile-box">
        <div class="row" id="profile-inside">
            <div class="col-xs-4 col-lg-12" id="initials-card">
                <div class="row">
                    <div id="initial-box" class="col-xs-10 col-xs-push-1 col-lg-4">
                        <div class="row">
                        <div class="height-11"></div>
                        <div id="initial">{{user.initial}}</div>
                    </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div id="greeting" class="col-xs-12">
                    Hello!
                </div>
                <div class="col-xs-12 profile-entry" id="user-name">
                    <div class="row">
                        <div class="col-xs-2 icon">
                            <span class="fa fa-user"></span>
                        </div>
                        <div class="col-xs-10 entry">
                            <div class="row">
                                <div class="data">
                                    <div class="col-xs-12 entry-data">
                                        {{user.name}}
                                    </div>
                                    <div class="col-xs-12 change-entry">
                                        Change Name
                                    </div>                                    
                                </div>
                                <div class="col-xs-12 input-form">
                                    <div class="input-form-box">
                                        <div class="col-xs-10 input-form-field">
                                            <input type="text" id="name-input">
                                        </div>
                                        <div class="col-xs-2 input-form-status">
                                            <span class="ti-check"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12 profile-entry" id="user-email">
                    <div class="row">
                        <div class="col-xs-2 icon">
                            <span class="fa fa-envelope"></span>
                        </div>
                        <div class="col-xs-10 entry">
                            <div class="row">
                                <div class="data">
                                    <div class="col-xs-12 entry-data">
                                        {{user.email}}
                                    </div>
                                    <div class="col-xs-12 change-entry">
                                        Change Email
                                    </div>
                                </div>
                                <div class="col-xs-12 input-form">
                                    <div class="input-form-box">
                                        <div class="col-xs-10 input-form-field">
                                            <input type="text" id="email-input">
                                        </div>
                                        <div class="col-xs-2 input-form-status">
                                            <span class="ti-check"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if user.organization %}
                <div class="col-xs-12 profile-entry" id="user-organization">
                    <div class="row">
                        <div class="col-xs-2 icon">
                            <span class="fa fa-university"></span>
                        </div>
                        <div class="col-xs-10 entry">
                            <div class="row">
                                <div class="col-xs-12 entry-data">
                                    {{user.organization.name}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                <div class="col-xs-12 profile-entry" id="user-website">
                    <div class="row">
                        <div class="col-xs-2 icon">
                            <span class="fa fa-link"></span>
                        </div>
                        <div class="col-xs-10 entry">
                            <div class="row">
                                <div class="data">
                                    {% if user.website %}
                                    <div class="col-xs-12 entry-data">
                                        {{user.website}}
                                    </div>
                                    <div class="col-xs-12 change-entry">
                                        Change Website
                                    </div>
                                    {% else %}
                                    <div class="col-xs-12 change-entry">
                                        Add Website
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-xs-12 input-form">
                                    <div class="input-form-box">
                                        <div class="col-xs-10 input-form-field">
                                            <input type="text" id="website-input">
                                        </div>
                                        <div class="col-xs-2 input-form-status">
                                            <span class="ti-check"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12" id="user-description">
                    <div class="row">
                        <div class="col-xs-2"></div>
                        <div class="col-xs-10 entry">
                            <div class="row">
                                <div class="data">
                                    {% if user.description %}
                                    <div class="col-xs-12 entry-data">
                                        {{user.description}}
                                    </div>
                                    <div class="col-xs-12 change-entry">
                                        Change Description
                                    </div>
                                    {% else %}
                                    <div class="col-xs-12 change-entry">
                                        Add Description
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-xs-12 input-form">
                                    <div class="input-form-box">
                                        <div class="col-xs-10 input-form-field">
                                            <textarea id="description-input"></textarea>
                                        </div>
                                        <div class="col-xs-2 input-form-status">
                                            <span class="ti-check"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

{% endblock %}

{% block bodyjs %}

<script type="text/javascript">

    var user_name_request = null, user_email_request = null; ;
    var user_description_request = null, user_website_request = null;

    $(document).on('click', '.change-entry', function(event){
        target = $(event.target).parent().parent().parent()
        target.find('.data').css("display", "none")
        input_form = target.find('.input-form')
        input_form.css("display", "block")
        input_form.find('input, textarea').focus()
    });

    $(document).on('click', '#user-name .input-form-status', function(event){
        if(event.target == $('#user-name .input-form-status'))
            target = $(event.target)
        else
            target = $(event.target).parent()
        val = $('#name-input').val()
        if(val == "")
        {
            user_name = $('#user-name')
            user_name.find('.data').css("display", "block")
            input_form = user_name.find('.input-form')
            input_form.css("display", "none")
            return
        }
        if (user_name_request)
        {
            user_name_request.abort()
            user_name_request = null;
        }

        target.html("<div class='loader-status'></div>")

        user_name_request = $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '/service/user/update',
            data: {"name": val},
            success: function(result){
                data = JSON.parse(result)
                if (data.result == "success")
                {
                    val = $('#name-input').val()
                    $('#name-input').val("")
                    $('#user-name .entry-data').html(val)
                    $('#account-btn').html(data.user_initials)
                    $('#initial').html(data.user_initials)
                    $('#user-name .input-form-status').html("<span class='ti-check'></span>")
                    user_name = $('#user-name')
                    user_name.find('.data').css("display", "block")
                    input_form = user_name.find('.input-form')
                    input_form.css("display", "none")
                }
                else
                {
                    console.log(data)
                    $('#user-description .input-form-status').html("<span class='ti-check'></span>")
                    user_description = $('#user-description')
                    user_description.find('.data').css("display", "block")
                    input_form = user_description.find('.input-form')
                    input_form.css("display", "none")
                }
            }
        });
    });

    $(document).on('click', '#user-email .input-form-status', function(event){

        if(event.target == $('#user-email .input-form-status'))
            target = $(event.target)
        else
            target = $(event.target).parent()
        val = $('#email-input').val()
        if(val == "")
        {
            user_email = $('#user-email')
            user_email.find('.data').css("display", "block")
            input_form = user_email.find('.input-form')
            input_form.css("display", "none")
            return
        }
        if (user_email_request)
        {
            user_email_request.abort()
            user_email_request = null;
        }

        target.html("<div class='loader-status'></div>")

        user_email_request = $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '/service/user/update',
            data: {"email": val},
            success: function(result){
                data = JSON.parse(result)
                if (data.result == "success")
                {
                    val = $('#email-input').val()
                    $('#email-input').val("")
                    $('#user-email .entry-data').html(val)
                    $('#user-email .input-form-status').html("<span class='ti-check'></span>")
                    user_email = $('#user-email')
                    user_email.find('.data').css("display", "block")
                    input_form = user_email.find('.input-form')
                    input_form.css("display", "none")
                }
                else
                {
                    console.log(data)
                    $('#user-description .input-form-status').html("<span class='ti-check'></span>")
                    user_description = $('#user-description')
                    user_description.find('.data').css("display", "block")
                    input_form = user_description.find('.input-form')
                    input_form.css("display", "none")
                }
            }
        });
    });

    $(document).on('click', '#user-website .input-form-status', function(event){

        if(event.target == $('#user-website .input-form-status'))
            target = $(event.target)
        else
            target = $(event.target).parent()
        val = $('#website-input').val()
        if (user_website_request)
        {
            user_website_request.abort()
            user_website_request = null;
        }

        target.html("<div class='loader-status'></div>")

        user_website_request = $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '/service/user/update',
            data: {"website": val},
            success: function(result){
                data = JSON.parse(result)
                if (data.result == "success")
                {
                    val = $('#website-input').val()
                    $('#website-input').val("")
                    if(val == "")
                    {
                        $('#user-website .data').html("<div class='col-xs-12 change-entry'>Add Website</div>")
                    }
                    else
                    {
                        $('#user-website .data').html("<div class=col-xs-12 entry-data>"+val+"</div><div class='col-xs-12 change-entry'>Change Website</div>")
                    }
                    $('#user-website .input-form-status').html("<span class='ti-check'></span>")
                    user_website = $('#user-website')
                    user_website.find('.data').css("display", "block")
                    input_form = user_website.find('.input-form')
                    input_form.css("display", "none")
                }
                else
                {
                    console.log(data)
                    $('#user-description .input-form-status').html("<span class='ti-check'></span>")
                    user_description = $('#user-description')
                    user_description.find('.data').css("display", "block")
                    input_form = user_description.find('.input-form')
                    input_form.css("display", "none")
                }
            }
        });
    });

    $(document).on('click', '#user-description .input-form-status', function(event){

        if(event.target == $('#user-description .input-form-status'))
            target = $(event.target)
        else
            target = $(event.target).parent()
        val = $('#description-input').val()
        if (user_description_request)
        {
            user_description_request.abort()
            user_description_request = null;
        }

        target.html("<div class='loader-status'></div>")

        user_description_request = $.ajax({
            type: 'GET',
            dataType: 'json',
            url: '/service/user/update',
            data: {"description": val},
            success: function(result){
                data = JSON.parse(result)
                if (data.result == "success")
                {
                    val = $('#description-input').val()
                    $('#description-input').val("")
                    if(val == "")
                    {
                        $('#user-description .data').html("<div class='col-xs-12 change-entry'>Add description</div>")
                    }
                    else
                    {
                        $('#user-description .data').html("<div class=col-xs-12 entry-data>"+val+"</div><div class='col-xs-12 change-entry'>Change description</div>")
                    }
                    $('#user-description .entry-data').html(val)
                    $('#user-description .input-form-status').html("<span class='ti-check'></span>")
                    user_description = $('#user-description')
                    user_description.find('.data').css("display", "block")
                    input_form = user_description.find('.input-form')
                    input_form.css("display", "none")
                }
                else
                {
                    console.log(data)
                    $('#user-description .input-form-status').html("<span class='ti-check'></span>")
                    user_description = $('#user-description')
                    user_description.find('.data').css("display", "block")
                    input_form = user_description.find('.input-form')
                    input_form.css("display", "none")
                }
            }
        });
    });

</script>

{% endblock %}